<!-- views/admin/mensaje_detalle.ejs -->
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="/socket.io/socket.io.js"></script>

  <script defer src="/js/chat-admin.js"></script>
  
  <script>

    const socket = io();
    
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("formulario-mensaje");
      const input = document.getElementById("mensaje-input"); // Ñ„Ğ¸ĞºÑ ID
      const clienteId = document.body.dataset.clienteid;
      const mensajesDiv = document.getElementById("mensajes");

      console.log("ğŸ“¦ clienteId Ğ¸Ğ· data-Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ğ°:", clienteId);

      if (!form || !clienteId) {
        console.log("âŒ No se encontrÃ³ el formulario o clienteId!");
        return;
      }

      // âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğº ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ DOM
      socket.emit("adminJoin", "cliente_" + clienteId);

      // ĞšĞ¾Ğ³Ğ´Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ Ğ¸Ğ»Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ ĞµĞ³Ğ¾ Ğ² Ñ‡Ğ°Ñ‚
      socket.on('nuevoMensaje', (msg) => {
      console.log('ğŸ“¨ Nuevo mensaje en WebSocket:', msg);

      const mensajesDiv = document.getElementById('mensajes');

      const div = document.createElement('div');
      div.className = msg.remitente === 'admin' ? 'mensaje-admin' : 'mensaje-cliente';
      div.innerHTML = `<strong>${msg.remitente === 'admin' ? 'Tu (admin)' : 'Cliente'}:</strong> ${msg.contenido}<br><small>${new Date(msg.fechaEnvio).toLocaleString()}</small>`;

      mensajesDiv.appendChild(div);
      mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
     });

      console.log("âœ… Formulario encontrado, agregando receptor");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("ğŸ“¨ Activado submit");

        const mensaje = input.value.trim();
        console.log("ğŸŸ¡ Haga clic en el botÃ³n de envÃ­o");
        console.log("ğŸ“¦ Texto del mensaje:", mensaje);

        if (mensaje === "") {
          console.log("âš ï¸ El mensaje estÃ¡ vacÃ­o: no se envÃ­a");
          return;
        }

        try {
          console.log("ğŸ“¡ Enviando fetch a /admin/mensajes/enviar");

          const response = await fetch("/admin/mensajes/enviar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ mensaje, clienteId }),
          });

          const data = await response.json();
          console.log("âœ… Respuesta del servidor:", data);

          if (data.success) {
            console.log("ğŸ‰ Mensaje enviado!");
            input.value = "";
          } else {
            console.log("âŒ Error del servidor:", data.message);
          }
        } catch (error) {
          console.error("ğŸ’¥ Error durante la fetch:", error);
        }
      });
    });

  </script>

  <style>
    #mensajes {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: scroll;
      padding: 10px;
      margin-bottom: 10px;
    }
    .mensaje-admin {
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      background-color: #cce5ff;
      text-align: right;
    }
    .mensaje-cliente {
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      background-color: #f8f9fa;
      text-align: left;
    }
  </style>
</head>
<body data-clienteId="<%= clienteId %>">
  <h1><%= title %></h1>
  <p><a href="/admin/mensajes">â¬… Volver a la lista de mensajes</a></p>

  <h3>Correspondencia con el cliente: <%= mensaje.Cliente.nombre %> (<%= mensaje.Cliente.email %>)</h3>

  <div id="mensajes">
    <% mensajesCliente.forEach(m => { %>
      <div class="<%= m.remitente === 'admin' ? 'mensaje-admin' : 'mensaje-cliente' %>">
        <strong><%= m.remitente === 'admin' ? 'Tu (admin)' : 'Cliente' %>:</strong> <%= m.contenido %><br>
        <small><%= new Date(m.fechaEnvio).toLocaleString() %></small>
      </div>
    <% }) %>
  </div>

  <form id="formulario-mensaje">
    <textarea id="mensaje-input" rows="4" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚..." required></textarea><br>
    <button id="btn-enviar" type="submit">Enviar respuesta</button>
  </form>

</body>
</html>